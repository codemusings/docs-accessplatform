<?xml version="1.0" encoding="iso-8859-1"?>
<document xmlns="http://maven.apache.org/XDOC/2.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/XDOC/2.0 http://maven.apache.org/xsd/xdoc-2.0.xsd">
    <properties>
        <title>Guides</title>
    </properties>

    <body>
        <section name="TomEE and DataNucleus JPA">
            <p>
                Apache TomEE ships with OpenJPA as the default JPA provider, however any valid JPA provider can be used.
            </p>
            <p>
                The basic steps are:
            </p>
            <ul>
            <li>Add the DataNucleus jars to <i>&lt;tomee-home&gt;/lib/</i></li>
            <li>Configure the webapp or the server to use DataNucleus.</li>
            </ul>

            <subsection name="Webapp Configuration">
                <p>
                    Any webapp can specify the JPA provider it would like to use via the <i>persistence.xml</i> file, which can be at any of the following locations in a webapp
                </p>
                <ul>
                <li>WEB-INF/persistence.xml of the .war file</li>
                <li>META-INF/persistence.xml in any jar located in WEB-INF/lib/</li>
                </ul>
                <p>
                    A single webapp may have many persistence.xml files and each may use whichever JPA provider it needs.
                    The following is an example of a fairly common persistence.xml for DataNucleus
                </p>
<source><![CDATA[
<persistence version="1.0"
       xmlns="http://java.sun.com/xml/ns/persistence"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://java.sun.com/xml/ns/persistence
       http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd">

    <persistence-unit name="movie-unit">
        <provider>org.datanucleus.api.jpa.PersistenceProviderImpl</provider>
        <jta-data-source>movieDatabase</jta-data-source>
        <non-jta-data-source>movieDatabaseUnmanaged</non-jta-data-source>

        <properties>
            <property name="datanucleus.schema.autoCreateAll" value="true"/>
        </properties>
    </persistence-unit>
</persistence>
]]></source>
                <p>
                    Note that you may have to set the persistence property <i>datanucleus.jtaLocator</i> and <i>datanucleus.jtaJndiLocation</i> to find your JNDI data sources.
                </p>
            </subsection>

            <subsection name="Server Configuration">
                <p>
                    The default JPA provider can be changed at the server level to favour DataNucleus over OpenJPA.
                    Using the <i>&lt;tomee-home&gt;/conf/system.properties</i> file or any other valid means of setting java.lang.System.getProperties(), 
                    the following standard properties can set the default for any persistence.xml file.
                </p>
<source>
javax.persistence.provider
javax.persistence.transactionType
javax.persistence.jtaDataSource
javax.persistence.nonJtaDataSource
</source>
                <p>
                    So, for example, DataNucleus can become the default provider via setting
                </p>
<source>CATALINA_OPTS=-Djavax.persistence.provider=org.datanucleus.api.jpa.PersistenceProviderImpl</source>
                <p>
                    You must of course add the DataNucleus libraries to <i>&lt;tomee-home&gt;/lib/</i> for this to work.
                </p>
            </subsection>

            <subsection name="DataNucleus libraries">
                <p>
                    Jars needed for DataNucleus 4.x:
                </p>
<source><![CDATA[
Add:
<tomee-home>/lib/datanucleus-core-4.0.0-m4.jar
<tomee-home>/lib/datanucleus-api-jpa-4.0.0-m4.jar
<tomee-home>/lib/datanucleus-rdbms-4.0.0-m4.jar

Remove (optional):
<tomee-home>/lib/asm-3.2.jar
<tomee-home>/lib/commons-lang-2.6.jar
<tomee-home>/lib/openjpa-2.2.0.jar
<tomee-home>/lib/serp-1.13.1.jar
]]></source>
            </subsection>
        </section>
    </body>
</document>

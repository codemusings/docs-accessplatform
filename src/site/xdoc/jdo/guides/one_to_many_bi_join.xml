<?xml version="1.0" encoding="iso-8859-1"?>
<document xmlns="http://maven.apache.org/XDOC/2.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/XDOC/2.0 http://maven.apache.org/xsd/xdoc-2.0.xsd">
    <properties>
        <title>Guides - 1-N Bidir Join Table Collection</title>
    </properties>

    <body>
        <section name="JDO Guides : 1-N Bidirectional Relation using Join Table">
            <a href="https://sourceforge.net/projects/datanucleus/files/datanucleus-samples/">
                <img src="../../images/download.png" alt="Download" border="0"/>
            </a>
            <a href="https://github.com/datanucleus/sample-jdo-one_to_many_join_bidir">
                <img src="../../images/source_code.png" alt="Source Code" border="0"/>
            </a>
        
            <p>
                This guide demonstrates a 1-N collection relationship between 2 classes. In this sample we
                have <b>Pack</b> and <b>Card</b> such that each <b>Pack</b> can contain many <b>Card</b>s. In addition
                each <b>Card</b> has a <b>Pack</b> that it belongs to. We demonstrate the classes themselves,
                and the MetaData necessary to persist them to the datastore in the way that we require. In this
                case we are going to persist the relation to an RDBMS using a Join Table.
            </p>
            <ol>
                <li><b><a href="#classes">Classes</a></b> - Design your Java classes to represent what you 
                    want to model in your system. Persistence doesn't have much of an impact on this stage, but 
                    we'll analyse the very minor influence it does have.</li>
                <li><b><a href="#identity">Object Identity</a></b> - Decide how the identities of your objects 
                    of these classes will be defined. Do you want JDO to give them id's or will you do it yourself.</li>
                <li><b>Meta-Data</b> - Define how your objects of these classes will be persisted.
                    <ol>
                        <li><b><a href="#newschema">New Database Schema</a></b> - you have a clean sheet 
                        of paper and can have them persisted with no constraints.</li>
                        <li><b><a href="#existingschema">Existing Database Schema</a></b> - you have 
                        existing tables that you need the objects persisted to.</li>
                    </ol>
                </li>
            </ol>

            <subsection name="The Classes">
                <p>
                    Let's look at our initial classes for the example. We want to represent a pack of cards.
                </p>
                <source><![CDATA[
package org.datanucleus.samples.packofcards.normal;

public class Pack
{
    String name=null;
    String description=null;

    Set    cards=new HashSet();

    public Pack(String name, String desc)
    {
        this.name = name;
        this.description = desc;
    }

    public void addCard(Card card)
    {
        cards.add(card);
    }

    public void removeCard(Card card)
    {
        cards.remove(card);
    }

    public Set getCards()
    {
        return cards;
    }

    public int getNumberOfCards()
    {
        return cards.size();
    }
}

public class Card
{
    String suit=null;
    String number=null;

    public Card(String suit,String number)
    {
        this.suit = suit;
        this.number = number;
    }

    public String getSuit()
    {
        return suit;
    }

    public String getNumber()
    {
        return number;
    }

    public String toString()
    {
        return "The " + number + " of " + suit;
    }
}]]></source>
                <p>
                    The first thing that we need to do is add a default constructor. This is a requirement of JDO. 
                    This can be private if we wish, so we add
                </p>
                <source><![CDATA[
public class Pack
{
    private Pack()
    {
    }

    ...
}
public class Card
{
    private Card()
    {
    }

    ...
}]]></source>
                <br/>
            </subsection>

            <a name="identity"/>
            <subsection name="Object Identity">
                <p>
                    The next thing to do is decide if we want to allow DataNucleus to generate the 
                    <a href="../value_generation.html">identities</a> of our objects, or whether we 
                    want to do it ourselves. In our case we will allow DataNucleus to create the identities for our 
                    <b>Pack</b>s, but since we know which <b>Card</b>s are in a pack we want to give them an 
                    identity based on the <i>suit</i> and the <i>number</i>. This allows us to give examples of
                    both <u>datastore identity</u> and <u>application identity</u>.
                </p>
                <p>
                    In the case of <b>Pack</b> there is nothing more to code since DataNucleus will handle the identities.
                    With <b>Card</b> however we now need to define a definition of the primary key. With JDO we must 
                    define a <i>primary key class</i>. In our case we want our primary key to be a composite of 
                    <i>suit</i> and <i>number</i>, so we define a primary key as follows
                </p>
                <source><![CDATA[
    public static class CardKey
    {
        public String suit;
        public String number;

        /**
         *  Default constructor (mandatory for JDO).
         */
        public CardKey()
        {
        }

        /**
         * String constructor (mandatory for JDO).
         **/
        public CardKey(String str) 
        {
            StringTokenizer toke = new StringTokenizer (str, "::");
            str = toke.nextToken ();
            this.suit = str;
            str = toke.nextToken ();
            this.number = str;
        }

        /**
         * Implementation of equals method (JDO requirement).
         **/
        public boolean equals(Object obj)
        {
            if (obj == this)
            {
                return true;
            }
            if (!(obj instanceof CardKey))
            {
                return false;
            }
            CardKey c=(CardKey)obj;

            return suit.equals(c.suit) &amp;&amp; number.equals(c.number);
        }

        /**
         * Implementation of hashCode (JDO requirement)
         */
        public int hashCode ()
        {
            return this.suit.hashCode() ^ this.number.hashCode();
        }

        /**
         * Implementation of toString that outputs this object id's PK values.
         * (JDO requirement).
         **/
        public String toString ()
        {
            return this.suit + "::" + this.number;
        }
    }]]></source>
                <p>
                    We decide that we don't want to use this class as an external object so we make it an inner 
                    class of our <b>Card</b> class. This is optional. You could have it as a class used elsewhere 
                    if you wish.
                </p>
                <br/>
            </subsection>

            <a name="newschema"/>
            <subsection name="MetaData for New Schema">
                <p>
                    Now that we've decided on our classes and how we want to define their identities we can decide 
                    on the precise persistence definition. In this section we'll describe how to persist these objects 
                    to a new database schema where we can create new tables and don't need to write to some 
                    existing table.
                </p>
                <p>
                    Some JDO tools provide an IDE to generate Meta-Data files, but DataNucleus doesn't currently. Either 
                    way it is a good idea to become familiar with the structure of these files since they define 
                    how your classes are persisted. Lets start with the header area. You add a block like this to 
                    define that the file is JDO Meta-Data
                </p>
                <source><![CDATA[
<?xml version="1.0"?>
<!DOCTYPE jdo PUBLIC 
    "-//Sun Microsystems, Inc.//DTD Java Data Objects Metadata 2.0//EN" 
    "http://java.sun.com/dtd/jdo_2_0.dtd">
<jdo>]]></source>
                <p>
                    Now lets define the persistence for our <b>Pack</b> class. We are going to use 
                    <u>datastore identity</u> here, meaning that DataNucleus will assign id's to each <b>Pack</b> object 
                    persisted and store them in a surrogate column in the datastore. We define it as follows
                </p>
                <source><![CDATA[
    <package name="org.datanucleus.samples.packofcards.normal">
        <class name="Pack" identity-type="datastore">
            <field name="name" persistence-modifier="persistent">
                <column length="100" jdbc-type="VARCHAR"/>
            </field>
            <field name="description" persistence-modifier="persistent">
                <column length="255" jdbc-type="VARCHAR"/>
            </field>
            <field name="cards" persistence-modifier="persistent">
                <collection element-type="org.datanucleus.samples.packofcards.normal.Card"/>
                <join/>
            </field>
        </class>]]></source>
                <p>
                    Here we've defined that our <i>name</i> field will be persisted to a VARCHAR(100) column, 
                    our <i>description</i> field will be persisted to a VARCHAR(255) column, and that our 
                    <i>cards</i> field is a Collection containing <b>org.datanucleus.samples.packofcards.normal.Card</b> 
                    objects. This final information is to inform DataNucleus to link the table for this class (via a 
                    foreign key) to the table for <b>Card</b> class. This is what is termed a <b><u>Join Table</u></b> 
                    relationship. Please refer to the 
                    <a href="../orm/one_to_many.html">1-N Relationships Guide</a> for more details on this. 
                    We'll discuss <b><u>ForeignKey</u></b> relationships in a different example.
                </p>
                <p>
                    Now lets define the persistence for our <b>Card</b> class. We are going to use 
                    <u>application identity</u> here, meaning that we store the id's for any object of type 
                    <b>Card</b> in a nominated field/fields, and that we can set the value if we so wish. 
                    We define it as follows
                </p>
                <source><![CDATA[
        <class name="Card" identity-type="application"
           objectid-class="org.datanucleus.samples.packofcards.normal.Card$CardKey">
            <field name="suit" primary-key="true">
                <column length="10" jdbc-type="VARCHAR"/>
            </field>
            <field name="number" primary-key="true">
                <column length="20" jdbc-type="VARCHAR"/>
            </field>
        </class>
    </package>]]></source>
                <p>
                    Here we've defined that our class uses <u>application identity</u> and that its primary key for 
                    this is <b>org.datanucleus.samples.packofcards.normal.Card$CardKey</b> (since its an inner class, we 
                    use the $ notation to define that). We've also defined that the 2 fields in this class are part 
                    of the primary key. You <b>must</b> define which fields are in the primary key.
                </p>

                <p>
                    We finally terminate the Meta-Data file with the closing tag
                </p>
                <source><![CDATA[
</jdo>]]></source>
            </subsection>

            <a name="existsingschema"/>
            <subsection name="MetaData for Existing Schema">
                <p>
                    Now that we've decided on our classes and how we want to define their identities we can decide 
                    on the precise persistence definition. In this section we'll describe how to persist these 
                    objects to an existing database schema where we already have some database tables from a 
                    previous persistence mechanism and we want to use those tables (because they have data in them). 
                    Our existing tables are shown below.
                </p>
                <img src="../../images/jdo/one_to_many_bi_join_existingschema.gif" alt=""/><br/>
                <p>
                    We will take the Meta-Data that was described in the previous section (New Schema) and continue 
                    from there. To recap, here is what we arrived at
                </p>
                <source><![CDATA[
<?xml version="1.0"?>
<!DOCTYPE jdo PUBLIC 
    "-//Sun Microsystems, Inc.//DTD Java Data Objects Metadata 2.0//EN" 
    "http://java.sun.com/dtd/jdo_2_0.dtd">
<jdo>
    <package name="org.datanucleus.samples.packofcards.normal">
        <class name="Pack" identity-type="datastore">
            <field name="name" persistence-modifier="persistent">
                <column length="100" jdbc-type="VARCHAR"/>
            </field>
            <field name="description" persistence-modifier="persistent">
                <column length="255" jdbc-type="VARCHAR"/>
            </field>
            <field name="cards" persistence-modifier="persistent">
                <collection element-type="org.datanucleus.samples.packofcards.normal.Card"/>
                <join/>
            </field>
        </class>
        <class name="Card" identity-type="application"
           objectid-class="org.datanucleus.samples.packofcards.normal.Card$CardKey">
            <field name="suit" primary-key="true">
                <column length="10" jdbc-type="VARCHAR"/>
            </field>
            <field name="number" primary-key="true">
                <column length="20" jdbc-type="VARCHAR"/>
            </field>
        </class>
    </package>
</jdo>]]></source>
                <p>
                    The first thing we need to do is map the <b>Pack</b> class to the table that we have in 
                    our database. It needs to be mapped to a table called "DECK", with columns "IDENTIFIERNAME"
                    and "DETAILS", and the identity column that DataNucleus uses needs to be called IDENTIFIER_ID. 
                    We do this by changing the Meta-Data to be
                </p>
                <source><![CDATA[
        <class name="Pack" identity-type="datastore" table="DECK">
            <datastore-identity>
                <column name="IDENTIFIER_ID"/>
            </datastore-identity>
            <field name="name" persistence-modifier="persistent">
                <column name="IDENTIFIERNAME" length="100" jdbc-type="VARCHAR"/>
            </field>
            <field name="description" persistence-modifier="persistent">
                <column name="DETAILS" length="255" jdbc-type="VARCHAR"/>
            </field>
            <field name="cards" persistence-modifier="persistent">
                <collection element-type="org.datanucleus.samples.packofcards.normal.Card"/>
                <join/>
            </field>
        </class>]]></source>
                <p>
                    So we made use of the attributes <i>table</i> (of element <b>class</b>) and <i>name</i> (of 
                    element <b>column</b>) to align to the table that is there. In addition we made use of the 
                    <i>datastore-identity</i> element to map the identity column name. Lets now do the same for 
                    the class <b>Card</b>. In our database we want this to map to a table called "PLAYINGCARD",
                    with columns "SET" and "VALUE". So we do the same thing to its Meta-Data
                </p>
                <source><![CDATA[
        <class name="Card" identity-type="application" table="PLAYINGCARD"
           objectid-class="org.datanucleus.samples.packofcards.normal.Card$CardKey">
            <field name="suit" primary-key="true">
                <column name="SET" length="10" jdbc-type="VARCHAR"/>
            </field>
            <field name="number" primary-key="true">
                <column name="VALUE" length="20" jdbc-type="VARCHAR"/>
            </field>
        </class>]]></source>
                <p>
                    OK, so we've now mapped our 2 classes to their tables. The only remaining thing is that to form 
                    our relationship with the "Join Table Relationship" we have a <i>join table</i> and in our database 
                    this is called "DECKOFCARDS" with columns "SET_ID", "VALUE_ID" and "DECK_ID". To map to these we 
                    need to further modify the Meta-Data for <b>Pack</b> as follows
                </p>
                <source><![CDATA[
        <class name="Pack" identity-type="datastore" table="DECK">
            <datastore-identity>
            	<column name="IDENTIFIER_ID"/>
            </datastore-identity>
            <field name="name" persistence-modifier="persistent">
                <column name="IDENTIFIERNAME" length="100" jdbc-type="VARCHAR"/>
            </field>
            <field name="description" persistence-modifier="persistent">
                <column name="DETAILS" length="255" jdbc-type="VARCHAR"/>
            </field>
            <field name="cards" persistence-modifier="persistent" table="DECKOFCARDS">
                <collection element-type="org.datanucleus.samples.packofcards.normal.Card"/>
                <join>
                    <column name="DECK_ID"/>
                </join>
                <element>
                    <column name="SET_ID" target="SET"/>
                    <column name="VALUE_ID" target="VALUE"/>
                </element>
            </field>
        </class>]]></source>
                <p> So we've now updated the <i>cards</i> field to use the new JDO 2 attributes 
                    <i>field</i>:<i>table</i>, <i>field</i>:<i>join</i>:<i>column</i>, and <i>field</i>:<i>element</i>:<i>column</i> 
                    to have the mapping to the existing table. Please note the use of multiple columns where we have 
                    to map to the composite primary key on Card. This completes our job. The only other aspect that 
                    is likely to be met is where a column in the database is of a particular type, but we'll cover 
                    that in a different example.
                </p>
                <p>
                    One thing worth mentioning is the difference if our Collection class was a List, ArrayList, 
                    Vector, etc. In this case we need to specify the ordering column for maintaining the order within 
                    the List. In our case we want to specify this column to be called "IDX", so we do it like this.
                </p>
                <source><![CDATA[
        <class name="Pack" identity-type="datastore" table="DECK">
            <datastore-identity>
            	<column name="IDENTIFIER_ID"/>
            </datastore-identity>
            <field name="name" persistence-modifier="persistent">
                <column name="IDENTIFIERNAME" length="100" jdbc-type="VARCHAR"/>
            </field>
            <field name="description" persistence-modifier="persistent">
                <column name="DETAILS" length="255" jdbc-type="VARCHAR"/>
            </field>
            <field name="cards" persistence-modifier="persistent" table="DECKOFCARDS">
                <collection element-type="org.datanucleus.samples.packofcards.normal.Card"/>
                <join>
                    <column name="DECK_ID"/>
                </join>
                <element>
                    <column name="SET_ID" target="SET"/>
                    <column name="VALUE_ID" target="VALUE"/>
                </element>
                <order column="IDX"/>
            </field>
        </class>]]></source>
        </subsection>
        </section>

    </body>
</document>